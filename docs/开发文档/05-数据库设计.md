# Mini-Todo - 数据库设计

## 1. 数据库概述

- **数据库类型**：SQLite
- **存储位置**：`%APPDATA%/mini-todo/data.db`
- **字符编码**：UTF-8

## 2. 表结构设计

### 2.1 待办表 (todos)

存储所有待办事项的主表。

```sql
CREATE TABLE IF NOT EXISTS todos (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    title           TEXT NOT NULL,
    description     TEXT,
    priority        TEXT NOT NULL DEFAULT 'medium' CHECK(priority IN ('high', 'medium', 'low')),
    notify_at       TEXT,                    -- ISO 8601 格式的时间字符串
    notify_before   INTEGER DEFAULT 0,       -- 提前通知分钟数
    notified        INTEGER DEFAULT 0,       -- 是否已发送通知 (0=否, 1=是)
    completed       INTEGER NOT NULL DEFAULT 0,
    sort_order      INTEGER NOT NULL DEFAULT 0,
    created_at      TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
    updated_at      TEXT NOT NULL DEFAULT (datetime('now', 'localtime'))
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_todos_completed ON todos(completed);
CREATE INDEX IF NOT EXISTS idx_todos_sort_order ON todos(sort_order);
CREATE INDEX IF NOT EXISTS idx_todos_notify_at ON todos(notify_at);
```

### 2.2 子任务表 (subtasks)

存储待办事项的子任务。

```sql
CREATE TABLE IF NOT EXISTS subtasks (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    parent_id       INTEGER NOT NULL,
    title           TEXT NOT NULL,
    completed       INTEGER NOT NULL DEFAULT 0,
    sort_order      INTEGER NOT NULL DEFAULT 0,
    created_at      TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
    updated_at      TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
    FOREIGN KEY (parent_id) REFERENCES todos(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_subtasks_parent_id ON subtasks(parent_id);
CREATE INDEX IF NOT EXISTS idx_subtasks_sort_order ON subtasks(sort_order);
```

### 2.3 应用设置表 (settings)

存储应用配置信息。

```sql
CREATE TABLE IF NOT EXISTS settings (
    key             TEXT PRIMARY KEY,
    value           TEXT NOT NULL,
    updated_at      TEXT NOT NULL DEFAULT (datetime('now', 'localtime'))
);
```

## 3. 字段说明

### 3.1 todos 表字段

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | 是 | AUTO | 主键，自增 |
| title | TEXT | 是 | - | 待办标题 |
| description | TEXT | 否 | NULL | 待办详细描述 |
| priority | TEXT | 是 | 'medium' | 优先级：high/medium/low |
| notify_at | TEXT | 否 | NULL | 通知时间 (ISO 8601) |
| notify_before | INTEGER | 否 | 0 | 提前通知分钟数 |
| notified | INTEGER | 否 | 0 | 是否已通知 |
| completed | INTEGER | 是 | 0 | 是否已完成 |
| sort_order | INTEGER | 是 | 0 | 排序权重 |
| created_at | TEXT | 是 | 当前时间 | 创建时间 |
| updated_at | TEXT | 是 | 当前时间 | 更新时间 |

### 3.2 subtasks 表字段

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | 是 | AUTO | 主键，自增 |
| parent_id | INTEGER | 是 | - | 父待办 ID（外键）|
| title | TEXT | 是 | - | 子任务标题 |
| completed | INTEGER | 是 | 0 | 是否已完成 |
| sort_order | INTEGER | 是 | 0 | 排序权重 |
| created_at | TEXT | 是 | 当前时间 | 创建时间 |
| updated_at | TEXT | 是 | 当前时间 | 更新时间 |

### 3.3 settings 表字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| key | TEXT | 是 | 设置键名（主键）|
| value | TEXT | 是 | 设置值（JSON 格式）|
| updated_at | TEXT | 是 | 更新时间 |

## 4. 常用设置键

| 键名 | 值类型 | 描述 | 示例值 |
|------|--------|------|--------|
| window_position | object | 窗口位置 | `{"x": 100, "y": 100}` |
| is_fixed | boolean | 是否固定模式 | `true` |
| last_export_path | string | 上次导出路径 | `"C:\\Users\\..."` |

## 5. 数据迁移

### 5.1 版本管理

```sql
CREATE TABLE IF NOT EXISTS migrations (
    version         INTEGER PRIMARY KEY,
    applied_at      TEXT NOT NULL DEFAULT (datetime('now', 'localtime'))
);
```

### 5.2 迁移脚本示例

```rust
// migrations.rs
pub fn run_migrations(conn: &Connection) -> Result<()> {
    let current_version = get_current_version(conn)?;
    
    if current_version < 1 {
        // V1: 初始表结构
        conn.execute_batch(include_str!("migrations/v1_initial.sql"))?;
        set_version(conn, 1)?;
    }
    
    if current_version < 2 {
        // V2: 添加新字段（示例）
        conn.execute_batch(include_str!("migrations/v2_add_fields.sql"))?;
        set_version(conn, 2)?;
    }
    
    Ok(())
}
```

## 6. 常用查询

### 6.1 获取所有待办（含子任务数）

```sql
SELECT 
    t.*,
    COUNT(s.id) as subtask_count,
    SUM(CASE WHEN s.completed = 1 THEN 1 ELSE 0 END) as completed_subtask_count
FROM todos t
LEFT JOIN subtasks s ON t.id = s.parent_id
WHERE t.completed = 0
GROUP BY t.id
ORDER BY t.sort_order ASC, t.created_at DESC;
```

### 6.2 获取待通知的待办

```sql
SELECT * FROM todos 
WHERE completed = 0 
  AND notified = 0 
  AND notify_at IS NOT NULL
  AND datetime(notify_at, '-' || notify_before || ' minutes') <= datetime('now', 'localtime');
```

### 6.3 更新排序顺序

```sql
-- 批量更新排序（使用事务）
BEGIN TRANSACTION;
UPDATE todos SET sort_order = 0 WHERE id = 3;
UPDATE todos SET sort_order = 1 WHERE id = 1;
UPDATE todos SET sort_order = 2 WHERE id = 2;
COMMIT;
```

## 7. 数据导出格式

```json
{
  "version": "1.0",
  "exported_at": "2026-01-28T12:00:00+08:00",
  "todos": [
    {
      "id": 1,
      "title": "完成项目文档",
      "description": "编写项目开发文档",
      "priority": "high",
      "notify_at": "2026-01-29T09:00:00+08:00",
      "notify_before": 15,
      "completed": false,
      "sort_order": 0,
      "created_at": "2026-01-28T10:00:00+08:00",
      "updated_at": "2026-01-28T10:00:00+08:00",
      "subtasks": [
        {
          "id": 1,
          "title": "编写概述",
          "completed": true,
          "sort_order": 0
        },
        {
          "id": 2,
          "title": "编写技术架构",
          "completed": false,
          "sort_order": 1
        }
      ]
    }
  ],
  "settings": {
    "window_position": {"x": 100, "y": 100},
    "is_fixed": false
  }
}
```

## 8. 性能优化

### 8.1 索引策略

- `completed` 字段索引：加速未完成/已完成筛选
- `sort_order` 字段索引：加速排序查询
- `notify_at` 字段索引：加速通知检查
- `parent_id` 字段索引：加速子任务关联查询

### 8.2 查询优化建议

1. 使用预编译语句（Prepared Statements）
2. 批量操作使用事务
3. 避免 SELECT *，只查询需要的字段
4. 定期执行 VACUUM 清理数据库
