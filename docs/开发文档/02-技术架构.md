# Mini-Todo - 技术架构设计

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Mini-Todo 应用                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   前端层 (Vue 3)                     │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐ │    │
│  │  │ 组件层  │  │ 状态层  │  │ 服务层  │  │ 工具层 │ │    │
│  │  │ Vue组件 │  │ Pinia   │  │ Tauri   │  │ Utils  │ │    │
│  │  └─────────┘  └─────────┘  └─────────┘  └────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                     Tauri IPC                               │
│                           │                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   后端层 (Rust)                      │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐ │    │
│  │  │ Commands│  │ 数据库  │  │ 通知    │  │ 窗口   │ │    │
│  │  │ 处理器  │  │ SQLite  │  │ 服务    │  │ 管理   │ │    │
│  │  └─────────┘  └─────────┘  └─────────┘  └────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
│                           │                                  │
│                     系统层 API                               │
│                           │                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Windows 系统服务                        │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────────────┐ │    │
│  │  │ 文件系统│  │ 通知中心│  │ 窗口管理器 (DWM)    │ │    │
│  │  └─────────┘  └─────────┘  └─────────────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 2. 前端架构

### 2.1 组件层次

```
App.vue
├── TitleBar.vue              # 自定义标题栏
│   ├── 模式切换按钮
│   ├── 固定/取消固定按钮
│   └── 设置按钮
├── TodoList.vue              # 待办列表容器
│   └── TodoItem.vue          # 单个待办项
│       └── SubTaskList.vue   # 子任务列表
│           └── SubTaskItem.vue
├── TodoEditor.vue            # 待办编辑弹窗
│   ├── 基本信息表单
│   ├── 优先级选择器
│   ├── 通知时间设置
│   └── 子任务管理
├── SettingsPanel.vue         # 设置面板
│   ├── 数据导入导出
│   └── 应用设置
└── NotificationToast.vue     # 应用内通知
```

### 2.2 状态管理 (Pinia)

```typescript
// stores/todoStore.ts
interface TodoStore {
  // 状态
  todos: Todo[];
  loading: boolean;
  
  // Getters
  sortedTodos: Todo[];
  pendingTodos: Todo[];
  completedTodos: Todo[];
  
  // Actions
  fetchTodos(): Promise<void>;
  addTodo(todo: CreateTodo): Promise<void>;
  updateTodo(id: number, data: UpdateTodo): Promise<void>;
  deleteTodo(id: number): Promise<void>;
  reorderTodos(ids: number[]): Promise<void>;
}

// stores/appStore.ts
interface AppStore {
  // 状态
  isFixed: boolean;           // 是否固定模式
  windowPosition: Position;   // 窗口位置
  
  // Actions
  toggleFixedMode(): Promise<void>;
  saveWindowPosition(): Promise<void>;
}
```

## 3. 后端架构 (Rust)

### 3.1 模块结构

```
src-tauri/src/
├── main.rs                   # 应用入口
├── lib.rs                    # 库定义
├── commands/                 # Tauri 命令
│   ├── mod.rs
│   ├── todo.rs              # 待办相关命令
│   ├── notification.rs      # 通知相关命令
│   └── window.rs            # 窗口相关命令
├── db/                       # 数据库模块
│   ├── mod.rs
│   ├── connection.rs        # 数据库连接
│   ├── migrations.rs        # 数据库迁移
│   └── models.rs            # 数据模型
└── services/                 # 业务服务
    ├── mod.rs
    ├── notification.rs      # 通知服务
    └── scheduler.rs         # 定时任务调度
```

### 3.2 主要 Tauri 命令

```rust
// 待办管理命令
#[tauri::command]
async fn get_todos() -> Result<Vec<Todo>, String>;

#[tauri::command]
async fn create_todo(todo: CreateTodo) -> Result<Todo, String>;

#[tauri::command]
async fn update_todo(id: i64, data: UpdateTodo) -> Result<Todo, String>;

#[tauri::command]
async fn delete_todo(id: i64) -> Result<(), String>;

#[tauri::command]
async fn reorder_todos(ids: Vec<i64>) -> Result<(), String>;

// 窗口管理命令
#[tauri::command]
async fn toggle_fixed_mode(window: Window, fixed: bool) -> Result<(), String>;

#[tauri::command]
async fn set_window_position(window: Window, x: i32, y: i32) -> Result<(), String>;

// 数据导入导出
#[tauri::command]
async fn export_data() -> Result<String, String>;

#[tauri::command]
async fn import_data(json: String) -> Result<(), String>;
```

## 4. 数据流

### 4.1 待办操作流程

```
用户操作 → Vue组件 → Pinia Store → Tauri Command → Rust处理 → SQLite
                                        ↓
用户界面 ← Vue组件 ← Pinia Store ← 返回结果 ← Rust处理
```

### 4.2 通知提醒流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  定时调度器  │────▶│  检查待办   │────▶│ 发送通知    │
│ (每分钟执行) │     │  到期时间   │     │ Windows API │
└─────────────┘     └─────────────┘     └─────────────┘
```

## 5. 依赖配置

### 5.1 前端依赖 (package.json)

```json
{
  "dependencies": {
    "vue": "^3.5.13",
    "@tauri-apps/api": "^2",
    "@tauri-apps/plugin-notification": "^2",
    "pinia": "^2.2.0",
    "element-plus": "^2.9.0",
    "@element-plus/icons-vue": "^2.3.1",
    "vuedraggable": "^4.1.0",
    "dayjs": "^1.11.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.2.1",
    "typescript": "~5.6.2",
    "vite": "^6.0.3",
    "vue-tsc": "^2.1.10",
    "@tauri-apps/cli": "^2",
    "sass": "^1.80.0"
  }
}
```

### 5.2 后端依赖 (Cargo.toml)

```toml
[dependencies]
tauri = { version = "2", features = [] }
tauri-plugin-notification = "2"
tauri-plugin-opener = "2"
tauri-plugin-dialog = "2"
tauri-plugin-fs = "2"
serde = { version = "1", features = ["derive"] }
serde_json = "1"
rusqlite = { version = "0.32", features = ["bundled"] }
chrono = { version = "0.4", features = ["serde"] }

# Windows 窗口管理
window-vibrancy = "0.5.2"
raw-window-handle = "0.6"

[target.'cfg(windows)'.dependencies]
windows = { version = "0.58.0", features = [
  "Win32_UI_WindowsAndMessaging",
  "Win32_Graphics_Dwm",
  "Win32_Graphics_Gdi",
  "Foundation"
] }
```

### 5.3 Windows 特殊功能

固定模式下使用 Windows API 实现以下功能：

- **WS_EX_TOOLWINDOW**: 使窗口忽略 Win+D（显示桌面）
- **透明窗口**: Tauri 配置 `transparent: true` + CSS 透明背景
- **窗口置顶**: `setAlwaysOnTop(true)`
